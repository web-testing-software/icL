% !TeX spellcheck = ro_RO
\section{Baze de date}

Modulul definește următoarele obiecte globale: \lstinline|DBManager| este managerul de baze de date, \lstinline|DB| este ultima bază de date deschisă, \lstinline|Query| este ultimul query.

Modulul \textit{Baze de date} definește următoarele posibilități:
\begin{icItems}
	\item \lstinline|DBManager.openSQLite (path : string) : DB|;
	\item \lstinline|DBManager.connect (server : string, user : string, password : string) : DB|;
	\item \lstinline|DBManager.connect (server : string) : DB|;
	\item \lstinline|DB.query (q : Code) : Query|;
	\item \lstinline|DB.close () : void|;
	\item \lstinline|[w/o] Query'(name : string) : any|;
	\item \lstinline|Query.set (field : string, value : any) : void|;
	\item \lstinline|Query.exec () : bool|;
	\item Disponibile după executare:
	\begin{icItems}
		\item \lstinline|[r/o] Query'(name : string) : any|;
		\item \lstinline|Query.getRowsAffected () : int|;
		\item \lstinline|Query.getError () : bool|;
		\item \lstinline|Query.getLength () : int|;
		\item \lstinline|Query.get (field : string) : any|;
		\item \lstinline|Query.next () : bool|;
		\item \lstinline|Query.previous () : bool|;
		\item \lstinline|Query.first () : bool|;
		\item \lstinline|Query.last () : bool|;
		\item \lstinline|Query.seek (i : int, relative = false) : bool|;
	\end{icItems}
\end{icItems}

\subsubsection{\lstinline|DBManager.openSQLite (path : string) : DB|}

Deschide o nouă conexiune. \code{path} e calea spre fișierul bazei de date.

\subsubsection{\lstinline|DBManager.connect (server : string, user : string, password : string) : DB|}

Se conectează la icL DB Client prin WebSockets, clienții pot fi scriși in orice limbaj de programare, pentru a crea clienți proprii faceți cunoștință cu \textit{icL DataBase Share over WebSockets}, descris în \textit{icL Wire Protocol}.

Excepții posibile: \ferror{NoSuchServer} și \ferror{WrongUserPassword} (pr. tab. \ref{errors}).

\subsubsection{\lstinline|DBManager.connect (server : string) : DB|}

Se conectează la icL DB Client prin HTTP, clienții pot fi scriși in orice limbaj de programare, pentru a crea clienți proprii faceți cunoștință cu \textit{icL DataBase Share over HTTP}, descris în \textit{icL Wire Protocol}.

Excepții posibile: \ferror{NoSuchServer} (pr. tab. \ref{errors}).

\subsubsection{\lstinline|DB.query (q : Code) : Query|}

Creează un query, pe bază de comandă SQL izolată în acolade.

\subsubsection{\lstinline|DB.close () : void|}

Închide conexiunea cu baza de date.

\subsubsection{\lstinline|[w/o] Query'(name : string) : any|}

Întoarce o valoare, care permite a schimba valoarea înlocuitorului prin atribuire. Înlocuitorul are următoarea sintaxă \lstinline|:name|.

\subsubsection{\lstinline|Query.set (field : string, value : any) : void|}

Atribuie valoarea înlocuitorului \code{field}.

\subsubsection{\lstinline|Query.exec () : bool|}

Returnează \true, dacă query-ului a fost executată cu succes, în caz contrar \false.

\subsubsection{\lstinline|Query.getError () : string|}

Returnează textul erorii, dacă la executarea query-ului a apărut o eroare.

\subsubsection{\lstinline|[r/o] Query'(name : string) : any|}

După executarea \lstinline|Query.exec| proprietățile vor returna valoarea cîmpurilor necesare. Dacă așa cîmp nu există, va fi returnat \void.

\subsubsection{\lstinline|Query.getRowsAffected () : int|}

Numărul de rînduri afectate/adăugate în baza de date.

Excepții posibile: \ferror{QueryNotExecutedYet} (pr. tab. \ref{errors}).

\subsubsection{\lstinline|Query.getLength () : int|}

Numărul de rezultate primit în rezultatul executării comenzii \code{SELECT}.

Excepții posibile: \ferror{QueryNotExecutedYet} (pr. tab. \ref{errors}).

\subsubsection{\lstinline|Query.get (field : string) : any|}

Returnează valoarea cîmpului \code{field} sau \void{} dacă așa cîmp nu există.

Excepții posibile: \ferror{QueryNotExecutedYet} (pr. tab. \ref{errors}).

\subsubsection{\lstinline|Query.next () : bool|}

Returnează \true, dacă s-a primit să treacă la următorul rînd, în caz contrar \false.

Excepții posibile: \ferror{QueryNotExecutedYet} (pr. tab. \ref{errors}).

\subsubsection{\lstinline|Query.previous () : bool|}

Returnează \true, dacă s-a primit să treacă la rîndul precedent, în caz contrar \false.

Excepții posibile: \ferror{QueryNotExecutedYet} (pr. tab. \ref{errors}).

\subsubsection{\lstinline|Query.first () : bool|}

Returnează \true, dacă s-a primit să treacă la primul rînd, în caz contrar \false.

Excepții posibile: \ferror{QueryNotExecutedYet} (pr. tab. \ref{errors}).

\subsubsection{\lstinline|Query.last () : bool|}

Returnează \true, dacă s-a primit să treacă la ultimul rînd, în caz contrar \false.

Excepții posibile: \ferror{QueryNotExecutedYet} (pr. tab. \ref{errors}).

\subsubsection{\lstinline|Query.seek (i : int, relative = false) : bool|}

Returnează \true, dacă s-a primit să treacă la al \code{i}-lea rînd sau să mute cursorul cu \code{i} rînduri (cu condiția că \code{@relative == true}), în caz contrar \false.

Excepții posibile: \ferror{QueryNotExecutedYet} (pr. tab. \ref{errors}).

\subsubsection{Exemplu}

Exemplu de cod, care folosește baze de date este prezentat pe foaia \ref{dbexample}. La fel ca și la executarea codului Javascript, în cod pot să fie prezente variabile icL, variabilele locale au următoarea sintaxă \code{@:name}, dar variabilele globale - \code{\#:name}.

\newpage
\begin{lstlisting}[caption=Exemplu de cod care folosește baze de date, label=dbexample]
DBManager.openSQLite "db.sqlite";

`` simple query
DB.query {
	SELECT country
	FROM artists
};
Query.exec;

while (Query.next) {
	!doSomething Query'country;
};

`` query with parameters
DB.query {
	SELECT name
	FROM programmers
	WHERE country = :country
	LIMIT 1
};
Query'country = "Moldova";
`` is equivalent to
@md = "Moldova";
DB.query {
	SELECT name
	FROM programmers
	WHERE country = @:md
	LIMIT 1
};

`` insert query
DB.query {
	INSERT INTO person (id, forname, name)
	VALUE (:id, :forname, :name)
};
Query'id = 1001;
Query'forname = "Bart";
Query'name = "Simpson";
Query.exec;
\end{lstlisting}

%\newpage
