% !TeX spellcheck = ru_RU
\section{Введение}

\textbf{icL} - \textbf{протокол общения}, специализированный под требованием программного обеспечения icL. Данный документ (так же как и программное обеспечение icL) распространяется под лицензий GNU GPLv3.

\subsection{Читатели}

Этот документ предназначен для всех тех людей, которые хотят понять как работает система icL изнутри и разрабатывать ПО для совместной работы с ней.

Чувствуйте себя свободным в указаниях на ошибки и представлении новых идей и точек зрения, жду ваших письмах по адресу icl@vivaldi.net.

\subsection{Структура запросов и ответов}

Все данные описываются на языке описания объектов \textit{JSON} и передаются через протокол \textit{WebSockets}.

Каждый запрос имеет следующие поля:
\begin{icItems}
	\item \jsinline{id} - идентификатор запроса;
	\item \jsinline{command} - идентификатор запроса;
	\item \jsinline{payload} - полезные данные, параметры.
\end{icItems}

Пример запроса -
\begin{jscode}
{
	id: 0,
	command: "ping",
	payload: {}
}
\end{jscode}

Каждый ответ содержит следующее поля:
\begin{icItems}
	\item \jsinline{id} - идентификатор запроса;
	\item \jsinline{code} - код ответа, в соответствия с кодами ответа протокола HTTP;
	\item \jsinline{description} - описание ответа, при ошибке будет содержать текстовое описание ошибки;
	\item \jsinline{payload} - полезные данные, содержимое ответа.
\end{icItems}

Пример ответа -
\begin{jscode}
{
	id: 0,
	command: "ping",
	code: 200,
	description: "ok",
	payload: {}
}
\end{jscode}

В будущем при описании запросов будут указаны только полезные данные, так как остальные повторяются.

\subsection{Аутентификация}

При подключении клиента к серверу для начала работы, сервер требует пройти аутентификацию (запрос \jsinline{"log-in"}). Полезные данные запроса аутентификация:
\begin{icItems}
	\item \jsinline{role} - роль, одно из следующих значения: \jsinline{"developer"}, \jsinline{"manager"}, \jsinline{"guest"}, \jsinline{"worker"};
	\item \jsinline{username} - имя пользователя;
	\item \jsinline{password} - пароль.
\end{icItems}

Роль \jsinline{"developer"} определяет пользователей подключенных через {\it icL IDE};

Роль \jsinline{"worker"} определяет клиентов icL Worker.

Роли \jsinline{"manager"} и \jsinline{"guest"} определяет клиентов icL Manager, только гости имеют право просить выполнение только одного теста в один момент времени. Когда менеджеры имеют полные права, включая создание и удаления новых пользователей.

Пример запроса идентификации -
\begin{jscode}
{
	id: 1,
	command: "log-in",
	payload: {
		role: "developer",
		username: "username",
		password: "password"
	}
}
\end{jscode}

Пример ответа -
\begin{jscode}
{
	id: 1,
	command: "log-in",
	code: 200,
	description: "ok",
	payload: { 
		successful: true 
	}
}
\end{jscode}

\subsection{Организация файлов на жёстком диске}

На клиенте для каждой сессий создаётся папка, в которой для каждого проекта создаётся отдельная папка. В папке проекта расположен файл с расширением {\it .icL}, который будет выполнен при запуске теста. Также в ней присутствуют папка {\it lib}, в которой располагаются вспомогательные файлы. И папка {\it res}, в которой расположены ресурсы.

Пример файловой системы -
\begin{jscode}
session/
	project1/
		main.icL
		lib/
			lib1.icL
			lib2.icL
		res/
			img1.png
			img2.png
		project2/
			..
			lib/
				..
			res/
				..
\end{jscode}

На сервере практически такая же структура, только в папке проекта создаётся отдельная папка для каждой версий, название таких папок формируется следующим образом: {\it release} или {\it draft} плюс номер версий, все черновики удаляются при загрузке релиза. В папке новой версии добавляются только те файлы которые были обновлены.

Пример файловой системы на сервере -

\begin{jscode}
session/
	project1/
		release1/
			main.icL
			lib/
				lib1.icL
				lib2.icL
			res/
				img1.png
				img2.png
		draft1/
			main.icL
		draft2/
			lib/
				lib2.icL
	project2/
		release1/
			..
\end{jscode}